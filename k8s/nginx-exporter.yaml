[file name]: nginx-exporter.yaml
[file content begin]
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: default
data:
  nginx.conf: |
    events {
        worker_connections 1024;
    }
    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        # Enable stub_status for metrics
        server {
            listen 80;
            server_name _;
            
            location / {
                root /usr/share/nginx/html;
                index index.html;
                try_files $uri $uri/ =404;
            }
            
            # HTML page showing metrics dashboard
            location /metrics-dashboard {
                alias /usr/share/nginx/html/metrics.html;
            }
            
            # JSON metrics endpoint for the app
            location /app-metrics {
                # Proxy to the nginx-exporter metrics
                proxy_pass http://localhost:9113/metrics;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
            }
            
            location /stub_status {
                stub_status on;
                access_log off;
            }
        }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: football-intro-app
  labels:
    app: football-intro-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: football-intro-app
  template:
    metadata:
      labels:
        app: football-intro-app
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9113"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      # Main application
      - name: football-intro-app
        image: football-intro-app:local
        imagePullPolicy: Never
        ports:
        - containerPort: 80
          name: http
        volumeMounts:
        - name: nginx-config
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
        # Add a volume for metrics HTML page
        - name: html-content
          mountPath: /usr/share/nginx/html/metrics.html
          subPath: metrics.html
        resources:
          requests:
            memory: "64Mi"
            cpu: "100m"
          limits:
            memory: "128Mi"
            cpu: "200m"
      
      # Nginx Prometheus Exporter sidecar
      - name: nginx-exporter
        image: nginx/nginx-prometheus-exporter:0.11.0
        args:
          - -nginx.scrape-uri=http://localhost:80/stub_status
        ports:
        - containerPort: 9113
          name: metrics
        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "64Mi"
            cpu: "100m"
      
      volumes:
      - name: nginx-config
        configMap:
          name: nginx-config
      - name: html-content
        configMap:
          name: metrics-dashboard-html
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: metrics-dashboard-html
data:
  metrics.html: |
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Football App Metrics Dashboard</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
                background-color: #f5f5f5;
            }
            .container {
                max-width: 1200px;
                margin: 0 auto;
            }
            header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 8px;
                margin-bottom: 20px;
            }
            .metrics-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 30px;
            }
            .metric-card {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                transition: transform 0.2s;
            }
            .metric-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            }
            .metric-value {
                font-size: 2.5em;
                font-weight: bold;
                color: #667eea;
                margin: 10px 0;
            }
            .metric-label {
                color: #666;
                font-size: 0.9em;
            }
            .refresh-btn {
                background: #667eea;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
                margin: 10px;
            }
            .refresh-btn:hover {
                background: #5a67d8;
            }
            .dashboard-links {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                margin-top: 20px;
            }
            .link-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 15px;
            }
            .dashboard-link {
                display: block;
                background: #f8f9fa;
                padding: 15px;
                border-radius: 5px;
                text-decoration: none;
                color: #333;
                border-left: 4px solid #667eea;
                transition: all 0.3s;
            }
            .dashboard-link:hover {
                background: #e9ecef;
                transform: translateX(5px);
            }
            .chart-container {
                background: white;
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                margin-bottom: 20px;
                height: 300px;
            }
            .timestamp {
                color: #999;
                font-size: 0.8em;
                margin-top: 20px;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>üèà Football App Metrics Dashboard</h1>
                <p>Real-time monitoring of your football application</p>
                <button class="refresh-btn" onclick="refreshMetrics()">üîÑ Refresh Metrics</button>
            </header>

            <div class="metrics-grid" id="metricsGrid">
                <!-- Metrics will be populated by JavaScript -->
            </div>

            <div class="dashboard-links">
                <h2>üîó Monitoring Tools</h2>
                <div class="link-grid">
                    <a href="/" class="dashboard-link">
                        <strong>üè† Main Application</strong>
                        <p>Return to the football application</p>
                    </a>
                    <a href="/app-metrics" class="dashboard-link">
                        <strong>üìä Raw Metrics (Prometheus)</strong>
                        <p>View raw Prometheus metrics</p>
                    </a>
                    <a href="http://localhost:9090" target="_blank" class="dashboard-link">
                        <strong>üìà Prometheus Dashboard</strong>
                        <p>Advanced querying and alerting</p>
                    </a>
                    <a href="http://localhost:3000" target="_blank" class="dashboard-link">
                        <strong>üìã Grafana Dashboards</strong>
                        <p>Professional visualization and dashboards</p>
                    </a>
                </div>
            </div>

            <div id="timestamp" class="timestamp"></div>
        </div>

        <script>
            const metrics = [
                { id: 'requests_total', name: 'Total Requests', query: 'sum(nginx_http_requests_total)', unit: '' },
                { id: 'requests_rate', name: 'Requests/Second', query: 'sum(rate(nginx_http_requests_total[5m]))', unit: 'req/s' },
                { id: 'connections_active', name: 'Active Connections', query: 'sum(nginx_connections_active)', unit: '' },
                { id: 'connections_reading', name: 'Reading Connections', query: 'sum(nginx_connections_reading)', unit: '' },
                { id: 'connections_writing', name: 'Writing Connections', query: 'sum(nginx_connections_writing)', unit: '' },
                { id: 'connections_waiting', name: 'Waiting Connections', query: 'sum(nginx_connections_waiting)', unit: '' }
            ];

            const prometheusUrl = 'http://localhost:9090/api/v1/query';

            async function fetchMetrics() {
                try {
                    const timestamp = new Date().toLocaleTimeString();
                    document.getElementById('timestamp').textContent = `Last updated: ${timestamp}`;

                    const metricsGrid = document.getElementById('metricsGrid');
                    let html = '';

                    for (const metric of metrics) {
                        const value = await fetchMetricValue(metric.query);
                        
                        html += `
                            <div class="metric-card">
                                <div class="metric-label">${metric.name}</div>
                                <div class="metric-value">${formatValue(value)}${metric.unit}</div>
                                <div class="metric-label">Query: ${metric.query}</div>
                            </div>
                        `;
                    }

                    metricsGrid.innerHTML = html;
                } catch (error) {
                    console.error('Error fetching metrics:', error);
                    document.getElementById('metricsGrid').innerHTML = `
                        <div class="metric-card" style="grid-column: 1 / -1; text-align: center; color: #dc3545;">
                            <h3>‚ö†Ô∏è Unable to fetch metrics</h3>
                            <p>Make sure Prometheus is running at <a href="http://localhost:9090" target="_blank">localhost:9090</a></p>
                            <p>Error: ${error.message}</p>
                        </div>
                    `;
                }
            }

            async function fetchMetricValue(query) {
                try {
                    const response = await fetch(`${prometheusUrl}?query=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    if (data.status === 'success' && data.data.result.length > 0) {
                        return parseFloat(data.data.result[0].value[1]);
                    }
                    return 0;
                } catch (error) {
                    console.error(`Error fetching ${query}:`, error);
                    return 'Error';
                }
            }

            function formatValue(value) {
                if (value === 'Error') return 'Error';
                if (value < 1) return value.toFixed(2);
                if (value < 10) return value.toFixed(1);
                if (value < 1000) return Math.round(value);
                if (value < 1000000) return (value / 1000).toFixed(1) + 'K';
                return (value / 1000000).toFixed(1) + 'M';
            }

            function refreshMetrics() {
                document.getElementById('metricsGrid').innerHTML = `
                    <div class="metric-card" style="grid-column: 1 / -1; text-align: center;">
                        <h3>‚è≥ Loading metrics...</h3>
                    </div>
                `;
                fetchMetrics();
            }

            // Initial load
            fetchMetrics();
            // Auto-refresh every 10 seconds
            setInterval(fetchMetrics, 10000);
        </script>
    </body>
    </html>
---
apiVersion: v1
kind: Service
metadata:
  name: football-intro-app-service
  labels:
    app: football-intro-app
spec:
  type: NodePort
  selector:
    app: football-intro-app
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 80
    nodePort: 30080
  - name: metrics
    protocol: TCP
    port: 9113
    targetPort: 9113
    nodePort: 30113
[file content end]
